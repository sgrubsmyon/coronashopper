<!-- Credit goes to: https://code.tutsplus.com/tutorials/create-a-contact-form-in-php--cms-32314 -->
<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weltladen Bonn Bestellformular</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <!-- <script type="module" src="https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.esm.js"></script> -->
  <!-- <script nomodule="" src="https://unpkg.com/ionicons@5.0.0/dist/ionicons/ionicons.js"></script> -->
  <script nomodule="" src="lib/ionicons.js"></script>
  <script type="module" src="lib/ionicons.esm.js"></script>
</head>

<body>
  <div class="form" id="form">
    <div class="back">
      <a href="https://www.weltladen-bonn.org">← Zurück zur Webseite</a>
    </div>
    <h1>
      <a href="https://www.weltladen-bonn.org"><img src="logo-weltladen_cmyk.svg" alt="Logo Weltladen Bonn e.V."></a>
      <div>Weltladen Bonn Bestellformular</div>
    </h1>
    <h2>Wir haben wieder regulär geöffnet, dieses Bestellformular steht Ihnen jedoch weiterhin zur Verfügung.</h2>
    <p>Wir erwarten in der Vorweihnachtszeit längere Wartezeiten beim Einkauf direkt im Laden aufgrund der
      Beschränkung auf maximal 4 Kund*innen im Laden, daher hilft es Ihnen und uns, wenn Sie vorbestellen
      und nur zum Abholen vorbeikommen.</p>
    <!-- Collapsible: https://alligator.io/css/collapsible/ -->
    <div class="wrap-collabsible">
      <input id="collapsible" class="toggle" type="checkbox">
      <label for="collapsible" class="lbl-toggle" tabindex="0">So geht's</label>
      <div class="collapsible-content">
        <div class="content-inner">
          <p>
            <ol>
              <li>Geben Sie Ihre Kontaktdaten an, wir benötigen sie zur Abwicklung der Bestellung (und nur dafür).</li>
              <li>Sie können Lebensmittel (oben) und Handwerksartikel (unten) über zwei Auswahlbereiche hinzufügen:
                Wählen Sie zuerst eine Produktgruppe aus und dann im Feld rechts davon eines der Produkte. Danach können Sie daneben die Stückzahl eingeben, ganz rechts erscheint der Gesamtpreis für dieses Produkt.</li>
              <li>Über den Button (+ Lebensmittel hinzufügen/Handwerk hinzufügen) fügen Sie Produkte hinzu, über das Mülltonnensymbol <span>(<ion-icon name="trash-outline" style="vertical-align: middle;"></ion-icon>)</span> können Sie sie löschen. Es gibt keine erforderliche Mindestbestellmenge
                pro Produkt.</li>
              <li>Wenn Sie etwas bestellen möchten, das Sie nicht in der Produktauswahl finden, können Sie es im Freitextfeld unter dem Gesamtpreis hinzufügen.
                Sie können dafür auch auf die Webseiten unserer Lieferanten schauen (s.u.) – was dort bestellbar ist, können auch wir Ihnen anbieten.
              </li>
              <li>Nach dem Klick auf „Absenden und Bestellen“ erhalten Sie die Übersicht Ihrer Bestellung per E-Mail zugeschickt.</li>
              <li>Wir melden uns anschließend bei Ihnen, um Ihnen das nächste mögliche Abholdatum zu nennen, außerdem um ggf. offene Fragen zu klären. Falls der Termin nicht passt, finden wir eine passende Alternative. <strong>Wichtig: bitte bestätigen Sie den Abholtermin, damit die Ware für Sie gepackt wird.</strong></li>
              <li>Kommen Sie zum vereinbarten Termin zum Laden und holen Sie Ihre Bestellung ab. Bitte halten Sie dabei die empfohlenen Hygieneempfehlungen ein, insbesondere den Abstand.</li>
              <li>Freuen Sie sich über leckere Produkte aus Fairem Handel. Sie unterstützen damit sowohl die lokalen Strukturen des Fairen Handels als auch die Fairhandelskooperativen und Kleinproduzent*innen weltweit!</li>
            </ol>
          </p>
          <p>
            Hier kommen Sie zu den Webseiten unserer Lieferanten, wenn Sie nach weiteren Produkten schauen möchten:
            <ul>
              <li>El Puente: <a href="https://shop.el-puente.de/">https://shop.el-puente.de/</a></li>
              <li>Ethiquable: <a href="https://www.ethiquable-shop.de/">https://www.ethiquable-shop.de/</a></li>
              <li>Fairtrade Center Breisgau: <a href="https://www.fairtradecenter.info/">https://www.fairtradecenter.info/</a></li>
              <li>Frida Feeling: <a href="https://www.fridafeeling.de/">https://www.fridafeeling.de/</a></li>
              <li>mafiafreie Produkte aus Italien: <a href="https://www.legalundlecker.de/">https://www.legalundlecker.de/</a></li>
              <li>GEPA: <a href="https://www.gepa-shop.de/">https://www.gepa-shop.de/</a></li>
              <li>GLOBO: <a href="https://www.globo-fairtrade.com/">https://www.globo-fairtrade.com/</a></li>
              <li>Putumayo: <a href="https://www.putumayo.com/">https://www.putumayo.com/</a></li>
              <li>WeltPartner (ehem. dwp): <a href="https://shop.weltpartner.de/">https://shop.weltpartner.de/</a></li>
            </ul>
          </p>
          <p>
            Bitte beachten Sie: Sollte ein Produkt nur in größeren Mengen (v.a. Lebensmittel) oder zu einem abweichenden Preis bestellbar sein, werden wir Sie vor der finalen Bestellung um Bestätigung bitten.
            Nicht vorrätige Ware braucht 1-2 Wochen, bis sie im Laden ist und abgeholt werden kann.
          </p>
        </div>
      </div>
    </div>
    <h2>Ihre Kontaktdaten:</h2>
    <form action="send-mail.php" method="post">
      <fieldset class="elem-group">
        <label for="name">Vor- und Nachname*</label>
        <input type="text" id="name" name="visitor_name" placeholder="Max Mustermann" pattern="[A-Z\sa-z-]{3,50}" required>
      </fieldset>
      <fieldset class="elem-group">
        <label for="email">E-Mail-Adresse*</label>
        <input type="email" id="email" name="visitor_email" placeholder="max.mustermann@beispiel.de" required>
      </fieldset>
      <fieldset class="elem-group">
        <label for="phone">Telefonnummer*</label>
        <input type="text" id="phone" name="visitor_phone" placeholder="0228/12345678" pattern="[+0-9 /\-]{3,30}" required>
      </fieldset>
      <fieldset class="elem-group">
        <label for="address">Adresse</label>
        <input type="text" id="address" name="visitor_address" placeholder="Max-Mustermann-Straße 12, 53123 Bonn" pattern="[\w\s.,\-\(\)/&+\*]{5,100}" v-bind:required="lieferung_required">
      </fieldset>
      <h2>Ich möchte folgende Produkte bestellen (vorbehaltlich Lieferbarkeit):</h2>
      <h3>1. Lebensmittel</h3>
      <fieldset class="elem-group">
        <div v-for="item in items.LM" class="product-selection">
          <div class="produktgruppe">
            <label v-bind:for="'productgroup'+item.position">Produktgruppe</label>
            <select v-bind:id="'productgroup'+item.position" v-bind:name="'productgroup'+item.position" v-model="item.productgroup" v-on:change="updateItemProducts('LM', item.position)" required>
              <option value="" disabled selected>Bitte auswählen...</option>
              <option v-for="pg in productGroupListLM" v-bind:value="pg">{{ pg }}</option>
            </select>
          </div>
          <div class="produkt">
            <label v-bind:for="'product'+item.position">Produkt</label>
            <div class="custom-select">
              <select v-bind:id="'product'+item.position" v-bind:name="'product'+item.position" v-model="item.id" v-on:change="updateItem(item)" required>
                <option value="" disabled selected>Bitte auswählen...</option>
                <option v-for="p in item.products" v-bind:value="p.lieferant_name+'______'+p.artikel_nr">{{ p.artikel_name + ' (' + p.lieferant_name + ')' }}</option>
              </select>
              <div class="select-selected" @click="item.showProdDropdown = !item.showProdDropdown" :class="{ 'select-arrow-active': item.showProdDropdown, 'nothing-selected': item.id == '' }">
                <div v-if="prodURL(item) != ''" class="produktimg" title="Klicken für mehr Infos">
                  <a target="_blank" rel="noopener noreferrer" :href="prodURL(item)">
                    <div :style="item.imgStyle"></div>
                  </a>
                </div>
                <div v-else class="produktimg">
                  <div :style="item.imgStyle"></div>
                </div>
                <div class="produktname">
                  <div :title="item.artikel_name">{{ item.artikel_name }}</div>
                </div>
                <div class="lieferant">{{ item.lieferant_name }}</div>
                <div class="preis">{{ currFormatter.format(item.vk_preis) }}</div>
                <div class="produktpfeil">
                  <div></div>
                </div>
              </div>
              <div class="select-items" v-show="item.showProdDropdown">
                <div v-for="p in item.products" v-on:click="item.id = p.lieferant_name+'______'+p.artikel_nr; updateItem(item)">
                  <div v-if="prodURL(p) != ''" class="produktimg" title="Klicken für mehr Infos">
                    <a target="_blank" rel="noopener noreferrer" :href="prodURL(p)">
                      <div :style="p.imgStyle"></div>
                    </a>
                  </div>
                  <div v-else class="produktimg">
                    <div :style="p.imgStyle"></div>
                  </div>
                  <div class="produktname">
                    <div :title="p.artikel_name">{{ p.artikel_name }}</div>
                  </div>
                  <div class="lieferant">{{ p.lieferant_name }}</div>
                  <div class="preis">{{ currFormatter.format(p.vk_preis) }}</div>
                </div>
              </div>
            </div>
          </div>
          <div class="stueck">
            <label v-bind:for="'stueck'+item.position">Stück</label>
            <input type="number" v-bind:id="'stueck'+item.position" v-bind:name="'stueck'+item.position" min="1" max="1000" v-model="item.stueck">
          </div>
          <div class="preis">
            <label v-bind:for="'preis'+item.position">Preis</label>
            <input type="text" v-bind:id="'preis'+item.position" v-bind:name="'preis'+item.position" v-bind:value="preis(item)" disabled>
          </div>
          <button type="button" class="muelltonne square" v-on:click="removeProduct('LM', item.position)"><ion-icon name="trash-outline"></ion-icon></button>
        </div>
        <button class="add-prod-button" type="button" v-on:click="addProduct('LM')">+ Lebensmittel hinzufügen</button>
        <div class="ges-betrag">
          <label for="teil-betrag-lm">Teilbetrag Lebensmittel (evtl. inkl. Pfand):</label>
          <input type="text" id="teil-betrag-lm" v-bind:value="gesBetrag()" disabled>
        </div>
      </fieldset>

      <h3>2. Handwerk</h3>
      <fieldset class="elem-group">
        <div v-for="item in items.KHW" class="product-selection">
          <div class="produktgruppe">
            <label v-bind:for="'productgroup'+item.position">Produktgruppe</label>
            <select v-bind:id="'productgroup'+item.position" v-bind:name="'productgroup'+item.position" v-model="item.productgroup" v-on:change="updateItemProducts('KHW', item.position)" required>
              <option value="" disabled selected>Bitte auswählen...</option>
              <option v-for="pg in productGroupListKHW" v-bind:value="pg">{{ pg }}</option>
            </select>
          </div>
        </div>
        <button class="add-prod-button" type="button" v-on:click="addProduct('KHW')">+ Handwerk hinzufügen</button>
        <div class="ges-betrag">
          <label for="teil-betrag-khw">Teilbetrag Handwerk:</label>
          <input type="text" id="teil-betrag-khw" v-bind:value="gesBetrag()" disabled>
        </div>
      </fieldset>
      <fieldset class="elem-group">
        <div class="ges-betrag">
          <label for="ges-betrag">Gesamtbetrag (evtl. inkl. Pfand):</label>
          <input type="text" id="ges-betrag" v-bind:value="gesBetrag()" disabled>
        </div>
      </fieldset>
      <fieldset class="elem-group">
        <label for="message">
          Ich habe Interesse an folgenden weiteren Produkten oder folgende Fragen,
          bitte senden Sie mir dazu Informationen zu: (Links zu den Webseiten der Lieferanten:
          siehe „So geht's“ oben auf der Seite)
        </label>
        <textarea id="message" name="visitor_message" placeholder="Hier können Sie z.B. weitere Produkte erwähnen, die wir dazu packen sollen."></textarea>
      </fieldset>
      <fieldset class="elem-group checkboxes">
        <input type="checkbox" id="datenschutz" name="datenschutz" value="datenschutz_true" required>
        <label for="datenschutz">
          * Hiermit willige ich ein, dass meine Daten ausschließlich zum Zweck der Abwicklung der hier
          eingegebenen Anfrage und Bestellung verwendet werden. Ist dieser Zweck erfüllt, werden meine
          Daten gelöscht, sofern keine gesetzlichen Aufbewahrungspflichten dagegen sprechen. Sind alle
          Aufbewahrungspflichten abgelaufen, werden die Daten vollständig gelöscht. Eine Verarbeitung
          zu anderem Zwecke oder Weitergabe an Dritte erfolgt grundsätzlich nicht.
        </label>
        <input type="checkbox" id="hygiene" name="hygiene" value="hygiene_true" required>
        <label for="hygiene">
          * Hiermit willige ich ein, mich bei der Übergabe der Bestellung an die derzeitigen Vorgaben
          und Empfehlungen für den sicheren Kontakt in der Öffentlichkeit zu halten, beispielsweise
          Vorgaben von Bund, Land und Stadt Bonn sowie Empfehlungen des Robert-Koch-Instituts, um weder
          mich noch die Mitarbeitenden des Weltladens noch andere Kund*innen zu gefährden.
        </label>
        <input type="checkbox" id="lieferung" name="lieferung" value="lieferung_true" v-model="lieferung_required">
        <label for="lieferung">
          Ich gehöre zu einer Risikogruppe, habe engen Kontakt mit Personen aus Riskogruppen oder
          befinde mich in Quarantäne, weshalb mir der Weg zum Weltladen unmöglich oder ein zu hohes
          Risiko ist. Bitte teilen Sie mir mit, ob meine Bestellung an die oben angegebene Anschrift
          geliefert werden kann. Für die Lieferung entstehen keine Kosten.
        </label>
      </fieldset>
      <label>* = Pflichtfeld</label>
      <fieldset>
        <button type="submit" v-bind:class="{ disabled: buttonIsDisabled() }" v-bind:disabled="buttonIsDisabled()">Bestellung abschicken</button>
      </fieldset>
    </form>
  </div>
  <!-- <script src="https://vuejs.org/js/vue.js"></script> (Development version) -->
  <script src="lib/vue.js"></script>
  <!-- <script src="https://vuejs.org/js/vue.min.js"></script> (Production version) -->
  <!-- <script src="lib/vue.min.js"></script> -->
  <!-- <script src="https://unpkg.com/vue-select@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/vue-select@latest/dist/vue-select.css"> -->
  <!-- <script src="lib/vue-select@latest"></script> -->
  <!-- <link rel="stylesheet" href="lib/vue-select.css"> -->
  <!-- <script src="https://unpkg.com/ionicons@5.0.0/dist/ionicons.js"></script> -->
  <!-- <script src="ionicons.js"></script> -->
  <!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
  <script src="lib/axios.min.js"></script>
  <script>
    window.onload = function() {
      // Collapsible: https://alligator.io/css/collapsible/
      let myLabels = document.querySelectorAll('.lbl-toggle');
      Array.from(myLabels).forEach(label => {
        label.addEventListener('keydown', e => {
          // 32 === spacebar
          // 13 === enter
          if (e.which === 32 || e.which === 13) {
            e.preventDefault();
            label.click();
          };
        });
      });
    }

    // Vue.component('v-select', VueSelect.VueSelect);

    Vue.config.ignoredElements = [/^ion-/];
    let itemPrototype = {
      position: 1,
      productgroup: "",
      products: [],
      id: "",
      lieferant_name: "",
      artikel_nr: "",
      artikel_name: "",
      vk_preis: 0,
      pfand: 0,
      stueck: 1,
      showProdDropdown: false
    };
    var app = new Vue({
      el: '#form',
      data: {
        productGroupListLM: [],
        productGroupListKHW: [],
        items: {
          LM: [Object.assign({}, itemPrototype)], // create a new copy, no reference
          KHW: [Object.assign({}, itemPrototype)] // create a new copy, no reference
        },
        lieferung_required: false,
        currFormatter: Intl.NumberFormat('de-DE', {
          style: 'currency',
          currency: 'EUR'
        })
      },
      methods: {
        addProduct: function(typ) {
          let currPosition = 0;
          if (this.items[typ].length > 0) {
            currPosition = this.items[typ][this.items[typ].length - 1].position;
          }
          let anotherPrototype = Object.assign({}, itemPrototype); // create a new copy, no reference
          anotherPrototype.position = currPosition + 1;
          console.log(itemPrototype);
          console.log(anotherPrototype);
          this.items[typ].push(anotherPrototype);
        },
        removeProduct: function(typ, position) {
          this.items[typ].splice(position - 1, 1);
          // same behavior as:
          // Vue.delete(this.items[typ], position - 1);
          /* reassign positions as it is necessary when product was not removed from end */
          let i = 1;
          for (let item of this.items[typ]) {
            item.position = i;
            i += 1;
          }
        },
        productsInGroupPromise: function(productgroup) {
          /* https://www.thetechieshouse.com/vue-js-rest-api-example-with-axios-ajax-alternative/ */
          /* https://stackoverflow.com/questions/49661209/get-response-from-axios-with-await-async */
          return axios.get('api/artikel/read_group.php', {
              params: {
                name: productgroup
              }
            })
            .then(response => response.data.records)
            .catch(error => console.log(error));
        },
        updateItemProducts: function(typ, position) {
          let item = this.items[typ][position - 1];
          this.productsInGroupPromise(item.productgroup)
            .then(prods => {
              prods.forEach(prod => {
                this.imageStyle(prod)
              });
              item.products = prods;
              item.id = "";
              item.lieferant_name = "";
              item.artikel_nr = "";
              item.artikel_name = "";
              item.vk_preis = 0;
              item.pfand = 0;
              item.stueck = 1;
              item.showProdDropdown = false;
            });
        },
        updateItem: function(item) {
          const prod = item.products.filter(p => {
            let id = item.id.split("______");
            return p.lieferant_name === id[0] && p.artikel_nr === id[1]
          })[0];
          item.lieferant_name = prod.lieferant_name;
          item.artikel_nr = prod.artikel_nr;
          item.artikel_name = prod.artikel_name;
          item.vk_preis = prod.vk_preis;
          item.pfand = prod.pfand;
          item.imgStyle = prod.imgStyle;
        },
        preis: function(item) {
          return this.currFormatter.format(item.vk_preis * item.stueck)
        },
        gesBetrag: function() {
          let gesPreis = 0;
          let gesPfand = 0;
          for (let typ of Object.keys(this.items)) {
            for (let i of this.items[typ]) {
              gesPreis = gesPreis + i.vk_preis * i.stueck;
              if (i.pfand) {
                gesPfand = gesPfand + i.pfand * i.stueck;
              }
            }
          }
          return this.currFormatter.format(gesPreis + gesPfand);
        },
        buttonIsDisabled: function() {
          let l = 0;
          for (let typ of Object.keys(this.items)) {
            l += this.items[typ].length;
          }
          return (l < 1);
        },
        imageStyle: function(prod) {
          let art_nr_alphanum = prod.artikel_nr.replace(/[^\w]/g, "").toLowerCase(); // only keep a-z and 0-9
          switch (prod.lieferant_name) {
            case 'El Puente':
              let a = prod.artikel_nr[0].toLowerCase(); // 1st character
              let b = prod.artikel_nr[1].toLowerCase(); // 2nd character
              // Sometimes cache is empty and image is generated only after product page was accessed:
              let url = "https://shop.el-puente.de/media/catalog/product/cache/image/700x700/e9c3970ab036de70892d86c6d221abfe/" + a + "/" + b + "/" + art_nr_alphanum + ".jpg";
              prod.imgStyle = "background-image: url('" + url + "');";
              // Also here, sometimes cache is empty, and the above is at least generated when product page is visited (by clicking on image):
              // "background-image: url('https://shop.el-puente.de/media/catalog/product/cache/thumbnail/130x160/beff4985b56e3afdbeabfc89641a4582/" + a + "/" + b + "/" + art_nr_alphanum + ".jpg');"
              // Check if image does not exist (cache is empty):
              let img = new Image();
              img.onerror = () => {
                // Set empty URL first, replace with actual url later after page was accessed
                prod.imgStyle = "background-image: url('');";
                // Access the El Puente product page so that the image is created in the cache
                axios.post('access-ep.php', {
                    url: this.prodURL(prod)
                  })
                  .then(response => {
                    // Try it again:
                    let img2 = new Image();
                    img2.onload = () => {
                      // If OK:
                      prod.imgStyle = "background-image: url('" + url + "');";
                    }
                    img2.src = url;
                  })
                  .catch(error => console.log(error));
              };
              img.src = url;
              break;
            case 'WeltPartner':
              prod.imgStyle = "background-image: url('https://shop.weltpartner.de/images/stories/virtuemart/product/resized/" + prod.artikel_nr.toLowerCase() + "_380x380.jpg');";
              break;
            case 'GEPA':
              prod.imgStyle = "background-image: url('https://www.gepa-wug.de/wug/bilder/inhalt/food/normal/" + art_nr_alphanum + ".jpg');";
              break;
            default:
              prod.imgStyle = "background-image: url('');";
          }
        },
        prodURL: function(prod) {
          let url = '';
          switch (prod.lieferant_name) {
            case 'El Puente':
              url = 'https://shop.el-puente.de/' + prod.artikel_nr.toLowerCase();
              break;
            case 'WeltPartner':
              url = 'https://shop.weltpartner.de/suche?keyword=' + prod.artikel_nr;
              break;
            case 'GEPA':
              let art_nr_alphanum = prod.artikel_nr.replace(/[^\w]/g, "").toLowerCase(); // only keep a-z and 0-9
              url = 'https://www.gepa-wug.de/wug/media/produktpass/' + art_nr_alphanum + '.pdf';
              break;
            default:
              url = '';
          }
          return url;
        }
      },
      mounted: function() {
        axios.get('api/produktgruppe/read_all.php', {
            params: {
              typ: "LM"
            }
          })
          .then(response => {
            let pgl = response.data.records;
            pgl = pgl.filter(pg => pg !== "Bananen");
            app.productGroupListLM = pgl;
          })
          .catch(error => console.log(error));
          axios.get('api/produktgruppe/read_all.php', {
            params: {
              typ: "KHW"
            }
          })
          .then(response => {
            let pgl = response.data.records;
            // pgl = pgl.filter(pg => pg !== "Whatever");
            app.productGroupListKHW = pgl;
          })
          .catch(error => console.log(error));
      }
    });

    /* If the user clicks anywhere outside the select box: close select box(es): */
    document.addEventListener("click", function(e) {
      let cls = "select-selected";
      if (!e.target.classList.contains(cls) &&
        (!e.target.parentNode.classList || !e.target.parentNode.classList.contains(cls)) && // either parent node does not exist (<html>) or it does not have the class
        (!e.target.parentNode.parentNode || !e.target.parentNode.parentNode.classList || !e.target.parentNode.parentNode.classList.contains(cls))) { // either parent node's parent node does not exist (<body>) or it does not have the class
        // close all dropdowns:
        for (let typ of Object.keys(app.items)) {
          for (let item of app.items[typ]) {
            item.showProdDropdown = false;
          }
        }
      }
    });
  </script>
</body>

</html>